#!/usr/bin/env python3
"""
AIFlowy API å®¢æˆ·ç«¯å·¥å…·
ç®€åŒ–APIè°ƒç”¨ï¼Œè‡ªåŠ¨å¤„ç†tokenã€JSONæ ¼å¼åŒ–ã€é”™è¯¯å¤„ç†ç­‰

ç”¨æ³•ç¤ºä¾‹:
    # ç™»å½•ï¼ˆç‰¹æ®Šå‘½ä»¤ï¼Œä¼šä¿å­˜tokenï¼‰
    ./scripts/api login admin 123456

    # GETè¯·æ±‚ - è·å–Botåˆ—è¡¨
    ./scripts/api GET bot/list

    # POSTè¯·æ±‚ - BotèŠå¤©
    ./scripts/api POST bot/chat -d '{"botId":"xxx","message":"ä½ å¥½","stream":false}'

    # æå–ç‰¹å®šå­—æ®µ
    ./scripts/api GET auth/getUserInfo -f data.nickname

    # æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
    ./scripts/api GET bot/list -v
"""

import argparse
import json
import sys
import os
from pathlib import Path

try:
    import requests
except ImportError:
    print("é”™è¯¯: ç¼ºå°‘ requests åº“", file=sys.stderr)
    print("å®‰è£…: pip3 install requests", file=sys.stderr)
    sys.exit(1)

# ============================================================================
# é…ç½® - AIFlowy é¡¹ç›®ä¸“ç”¨
# ============================================================================
API_BASE = os.environ.get("AIFLOWY_API_BASE", "http://localhost:8213/api/v1")
TOKEN_FILE = "/tmp/.aiflowy.token"
TOKEN_HEADER = "aiflowy-token"  # AIFlowy ä½¿ç”¨è‡ªå®šä¹‰ header


def save_token(token):
    """ä¿å­˜tokenåˆ°æ–‡ä»¶"""
    token_path = Path(TOKEN_FILE)
    token_path.write_text(token)
    token_path.chmod(0o600)
    print(f"âœ… Token å·²ä¿å­˜åˆ° {TOKEN_FILE}", file=sys.stderr)


def get_token():
    """è¯»å–API token"""
    token_path = Path(TOKEN_FILE)
    if not token_path.exists():
        print(f"âŒ é”™è¯¯: tokenæ–‡ä»¶ä¸å­˜åœ¨: {TOKEN_FILE}", file=sys.stderr)
        print("è¯·å…ˆè¿è¡Œ: make login æˆ– ./scripts/api login <account> <password>", file=sys.stderr)
        sys.exit(1)
    return token_path.read_text().strip()


def do_login(account, password, verbose=False):
    """æ‰§è¡Œç™»å½•å¹¶ä¿å­˜token"""
    url = f"{API_BASE}/auth/login"

    if verbose:
        print(f"ğŸ“¡ ç™»å½•: POST {url}", file=sys.stderr)

    try:
        response = requests.post(
            url,
            json={"account": account, "password": password},
            headers={"Content-Type": "application/json"},
            timeout=30
        )

        if response.status_code == 200:
            data = response.json()
            # AIFlowy çš„ token åœ¨ data.token ä¸­
            token = data.get("data", {}).get("token")
            if token:
                save_token(token)
                print(f"âœ… ç™»å½•æˆåŠŸ: {account}", file=sys.stderr)
                print(f"ğŸ’¡ Token æœ‰æ•ˆæœŸ: 24å°æ—¶", file=sys.stderr)
                return True

        print(f"âŒ ç™»å½•å¤±è´¥: {response.text}", file=sys.stderr)
        return False

    except Exception as e:
        print(f"âŒ ç™»å½•å¤±è´¥: {e}", file=sys.stderr)
        return False


def parse_query_params(args):
    """è§£æå‘½ä»¤è¡Œä¸­çš„æŸ¥è¯¢å‚æ•° (key=valueæ ¼å¼)"""
    params = {}
    for arg in args:
        if '=' in arg and not arg.startswith('-'):
            key, value = arg.split('=', 1)
            params[key] = value
    return params


def make_request(method, path, data=None, params=None, verbose=False):
    """å‘é€HTTPè¯·æ±‚"""
    token = get_token()
    url = f"{API_BASE}/{path.lstrip('/')}"

    # AIFlowy ä½¿ç”¨ aiflowy-token header
    headers = {
        TOKEN_HEADER: token,
        "Content-Type": "application/json"
    }

    if verbose:
        print(f"ğŸ“¡ è¯·æ±‚: {method.upper()} {url}", file=sys.stderr)
        if params:
            print(f"ğŸ“‹ å‚æ•°: {params}", file=sys.stderr)
        if data:
            print(f"ğŸ“¦ æ•°æ®:\n{json.dumps(data, indent=2, ensure_ascii=False)}", file=sys.stderr)

    try:
        response = requests.request(
            method=method.upper(),
            url=url,
            json=data,
            params=params,
            headers=headers,
            timeout=30
        )

        if verbose:
            print(f"âœ… çŠ¶æ€ç : {response.status_code}", file=sys.stderr)

        return response

    except requests.exceptions.Timeout:
        print("âŒ è¯·æ±‚è¶…æ—¶", file=sys.stderr)
        sys.exit(1)
    except requests.exceptions.ConnectionError:
        print(f"âŒ è¿æ¥å¤±è´¥: æ— æ³•è¿æ¥åˆ° {API_BASE}", file=sys.stderr)
        print("æç¤º: è¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ (make start)", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"âŒ è¯·æ±‚å¤±è´¥: {e}", file=sys.stderr)
        sys.exit(1)


def extract_field(data, field_path):
    """ä»JSONä¸­æå–å­—æ®µ (æ”¯æŒç‚¹åˆ†éš”è·¯å¾„)"""
    result = data
    for key in field_path.split('.'):
        if isinstance(result, dict):
            result = result.get(key)
        elif isinstance(result, list) and key.isdigit():
            result = result[int(key)]
        else:
            return None
    return result


def format_output(response, args):
    """æ ¼å¼åŒ–è¾“å‡º"""
    # åŸå§‹è¾“å‡º
    if args.raw:
        print(response.text)
        return

    # æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
    content_type = response.headers.get('Content-Type', '')

    # å¦‚æœä¸æ˜¯JSONç±»å‹ï¼Œç›´æ¥è¾“å‡ºæ–‡æœ¬
    if 'application/json' not in content_type and response.text:
        print(response.text)
        return

    # JSONè¾“å‡º
    try:
        json_data = response.json()

        # æå–ç‰¹å®šå­—æ®µ
        if args.field:
            result = extract_field(json_data, args.field)
            if result is None:
                print(f"âŒ å­—æ®µä¸å­˜åœ¨: {args.field}", file=sys.stderr)
                sys.exit(1)

            # å¦‚æœæ˜¯ç®€å•ç±»å‹ï¼Œç›´æ¥è¾“å‡º
            if isinstance(result, (str, int, float, bool)):
                print(result)
            else:
                print(json.dumps(result, indent=2, ensure_ascii=False))
        else:
            # ç¾åŒ–JSONè¾“å‡º
            print(json.dumps(json_data, indent=2, ensure_ascii=False))

    except (json.JSONDecodeError, ValueError) as e:
        if not args.quiet:
            print(f"âš ï¸  å“åº”ä¸æ˜¯æœ‰æ•ˆçš„JSON: {e}", file=sys.stderr)
        print(response.text)


def main():
    parser = argparse.ArgumentParser(
        description="AIFlowy API å®¢æˆ·ç«¯ - ç®€åŒ–APIè°ƒç”¨",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹:
  %(prog)s login admin 123456           # ç™»å½•å¹¶ä¿å­˜token
  %(prog)s GET bot/list                 # è·å–Botåˆ—è¡¨
  %(prog)s GET auth/getUserInfo         # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  %(prog)s POST bot/chat -d '{"botId":"xxx","message":"ä½ å¥½","stream":false}'
  %(prog)s GET bot/getDetail id=xxx -f data.title
        """
    )

    parser.add_argument(
        "method",
        help="HTTPæ–¹æ³• (GET/POST/PUT/DELETE/PATCH) æˆ– 'login' å‘½ä»¤"
    )
    parser.add_argument(
        "path",
        nargs="?",
        default="",
        help="APIè·¯å¾„ (ä¾‹å¦‚: bot/list, auth/getUserInfo) æˆ–ç™»å½•æ—¶çš„è´¦å·"
    )
    parser.add_argument(
        "params",
        nargs="*",
        help="æŸ¥è¯¢å‚æ•° (æ ¼å¼: key=value) æˆ–ç™»å½•æ—¶çš„å¯†ç "
    )
    parser.add_argument(
        "-d", "--data",
        help="è¯·æ±‚ä½“JSONæ•°æ®"
    )
    parser.add_argument(
        "-f", "--field",
        help="æå–ç‰¹å®šå­—æ®µ (ä¾‹å¦‚: data.id, data.0.name)"
    )
    parser.add_argument(
        "-r", "--raw",
        action="store_true",
        help="è¾“å‡ºåŸå§‹å“åº”ï¼ˆä¸æ ¼å¼åŒ–JSONï¼‰"
    )
    parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯ï¼ˆè¯·æ±‚è¯¦æƒ…ã€çŠ¶æ€ç ç­‰ï¼‰"
    )
    parser.add_argument(
        "-q", "--quiet",
        action="store_true",
        help="é™é»˜æ¨¡å¼ï¼ˆä»…è¾“å‡ºç»“æœï¼Œä¸è¾“å‡ºé”™è¯¯ï¼‰"
    )

    args = parser.parse_args()

    # å¤„ç† login å‘½ä»¤
    if args.method.lower() == "login":
        account = args.path
        password = args.params[0] if args.params else ""
        if not account or not password:
            print("ç”¨æ³•: ./scripts/api login <account> <password>", file=sys.stderr)
            sys.exit(1)
        success = do_login(account, password, args.verbose)
        sys.exit(0 if success else 1)

    # éªŒè¯ HTTP æ–¹æ³•
    valid_methods = ["GET", "POST", "PUT", "DELETE", "PATCH"]
    if args.method.upper() not in valid_methods:
        print(f"âŒ æ— æ•ˆçš„HTTPæ–¹æ³•: {args.method}", file=sys.stderr)
        print(f"æœ‰æ•ˆæ–¹æ³•: {', '.join(valid_methods)} æˆ– login", file=sys.stderr)
        sys.exit(1)

    # è§£ææ•°æ®å’Œå‚æ•°
    data = None
    if args.data:
        try:
            data = json.loads(args.data)
        except json.JSONDecodeError as e:
            if not args.quiet:
                print(f"âŒ JSONæ ¼å¼é”™è¯¯: {e}", file=sys.stderr)
            sys.exit(1)

    params = parse_query_params(args.params) if args.params else None

    # å‘é€è¯·æ±‚
    response = make_request(args.method, args.path, data, params, args.verbose)

    # æ ¼å¼åŒ–è¾“å‡º
    format_output(response, args)

    # é”™è¯¯çŠ¶æ€ç æ—¶é€€å‡ºç é0
    if response.status_code >= 400:
        if not args.quiet:
            print(f"âŒ HTTP {response.status_code}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
